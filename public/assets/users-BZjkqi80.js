import{a as E}from"./avatar-1-BeeGmpGQ.js";import{_ as F}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{a as v,V as w,d as L}from"./VCard-CJiMiPPD.js";import{V as S}from"./VDataTable-_oT9lWy4.js";import{a as C,V as n}from"./VRow-DEN-ZUQ3.js";import{d as V}from"./VTextField-DRF_CiRP.js";import{a as U,b as A,c as z,V as j}from"./VSnackbar-CIiVjrhf.js";import{e as y}from"./VChip-Cfe0npL1.js";import{V as H}from"./VDialog-BucekFA9.js";import{v as B,o as r,e as m,w as l,b as s,a as u,t as g,l as b,c as $,a3 as c,a0 as P,V as h,H as f,au as N,k as q,F as D}from"./main-fuAEsUyz.js";import{V as R}from"./VSpacer-Cn4stOG3.js";import{V as G}from"./VForm-BKgv5Oyh.js";import{V as O}from"./VContainer-HCI4JAqU.js";import{V as I}from"./VAvatar-uRQQgG6Z.js";import{V as M}from"./VDivider-D7HzMRKX.js";import{V as J}from"./VTooltip-CwLOmQvP.js";import{V as K}from"./VSwitch-6vUgLz9_.js";import"./VImg-Cb5AUxXm.js";import"./forwardRefs-C-GTDzx5.js";import"./VOverlay-B30_GVbc.js";import"./easing-DY7PVvcf.js";import"./lazy-Cb-wTBYG.js";import"./VCheckboxBtn-BZ0TBRnf.js";import"./VTable-XPapKC5i.js";import"./index-CgjNwtvj.js";import"./ssrBoot-C_kI6-dQ.js";var W={};const Q={data:()=>({imagePreview:null,imageFile:null,avatar:E,title:"Usuarios",route:"users",dialog:!1,snackbar:!1,text:"Registro Insertado",color:"success",timeout:4e3,search:"",valid:!0,showPassword:!1,headers:[{title:"Acciones",key:"actions",value:"actions",sortable:!1,width:"150px"},{title:"Imagen",key:"image",sortable:!1,width:"100px"},{title:"Nombre",filterable:!0,key:"name"},{title:"Email",filterable:!0,key:"email"},{title:"Tenant",key:"tenant.name",width:"100px",width:"100px"},{title:"Roles",key:"roles",sortable:!1},{title:"Estado",key:"active",width:"150px"}],desserts:[],editedIndex:-1,tenants:[],roles:[],editedItem:{id:"",name:"",email:"",password:"",tenant_id:null,roles:[],active:1,image:""},defaultItem:{id:"",name:"",email:"",password:"",tenant_id:null,roles:[],active:1,image:""},selectedHeaders:[],emailRules:[e=>!!e||"Email es requerido",e=>/.+@.+\..+/.test(e)||"Email debe ser válido"],passwordRules:[e=>!!e||"Contraseña es requerida",e=>e&&e.length>=8||"Mínimo 8 caracteres"],rolesLoading:!1}),watch:{dialog(e){e||this.close()},"editedItem.tenant_id":{handler(e){this.dialog&&(this.loadRoles(e),this.editedItem.roles=[])},immediate:!1}},created(){this.initialize(),this.selectedHeaders=this.headers,this.loadTenants()},computed:{formTitle(){return this.editedIndex===-1?"Registrar Usuario":"Editar Usuario"},showHeaders(){return this.headers.filter(e=>this.selectedHeaders.includes(e))},filteredDesserts(){if(!this.search)return this.desserts;const e=this.search.toLowerCase();return this.desserts.filter(a=>a.name.toLowerCase().includes(e)||a.email.toLowerCase().includes(e)||a.tenant&&a.tenant.name.toLowerCase().includes(e))}},methods:{async initialize(){try{let e="";this.$is("superadmin")?e=this.route:e="usersList";const a=await this.$axios.get(this.$routes[e]);this.desserts=a.data.data}catch(e){console.error("Error cargando usuarios:",e)}},async loadTenants(){try{let e=this.$routes.tenants;if(this.$is("superadmin")){const a=await this.$axios.get(e);this.tenants=a.data.data}else{e=this.$routes.tenants+"/"+this.$store.getters.currentUser.data.tenant.id;const a=await this.$axios.get(e);this.tenants=[a.data.data]}}catch(e){console.error("Error cargando tenants:",e)}},async loadRoles(e){this.rolesLoading=!0;try{if(!e)return this.roles=[],Promise.resolve();const a=await this.$axios.get(`${this.$routes.roles}?tenant_id=${e}`);return this.roles=a.data.data,Promise.resolve()}catch(a){return console.error("Error cargando roles:",a),Promise.reject(a)}finally{this.rolesLoading=!1}},handleImageUpload(e){var o;const a=(o=e.target.files)==null?void 0:o[0];this.imagePreview=a?URL.createObjectURL(a):""},handleFileUpload(e){const a=e.target.files[0];if(!a)return;if(!["image/jpeg","image/png","image/gif","image/jpg"].includes(a.type)){this.showSnackbar("Formato de imagen no válido. Use JPG, PNG o GIF.","error");return}if(a.size>800*1024){this.showSnackbar("La imagen es demasiado grande (máx. 800KB)","error");return}this.editedItem.imageFile=a;const p=new FileReader;p.onload=k=>{this.imagePreview=k.target.result},p.readAsDataURL(a)},resetAvatar(){this.imagePreview=null,this.imageFile=null,this.editedItem.image=null,this.$refs.fileInput&&(this.$refs.fileInput.value="")},getImageUrl(e){return e?e.startsWith("http")?e:`${W.VUE_APP_API_URL||""}/storage/users/${e}`:""},async editItem(e){this.editedIndex=e.id,this.editedItem=Object.assign({},e),console.log(this.editedIndex),console.log(this.editedItem),e.image?this.imagePreview=this.getImageUrl(e.image):this.imagePreview=null,this.dialog=!0,await this.$nextTick(),this.loadRoles(e.tenant_id).then(()=>{this.editedItem.roles=this.roles.filter(a=>e.roles.some(o=>o.id===a.id))})},close(){this.dialog=!1,this.$nextTick(()=>{this.editedItem=Object.assign({},this.defaultItem),this.editedIndex=-1,this.imagePreview=null,this.resetAvatar()})},showSnackbar(e,a){this.text=e,this.color=a,this.snackbar=!0},getTenantColor(e){return e.tenant?["primary","secondary","success","info","warning","error"][e.tenant.id]:"grey"},getRandomColor(e){return["primary","secondary","success","info","warning","error"][e.roles[0].id]},async toggleActive(e){Swal.alertGetInfo("Actualizando información");const a=e.active;console.log("item.active"),console.log(e.active);try{let o=this.$routes.users,p=new FormData;Object.keys(this.editedItem).forEach(i=>{i!=="imageFiles"&&i!=="image"&&p.append(i,this.editedItem[i])}),p.append("_method","PUT"),(await this.$axios.post(o+"_changestatus/"+e.id,p)).data.code==200?(this.snackbar=!0,this.text="Se modificó el estado con exito.",this.color="success"):(e.active=a,this.snackbar=!0,this.text="Error al cambiar el estado",this.color="error"),this.initialize()}catch(o){e.active=a,console.error("Error al cambiar el estado:",o),this.snackbar=!0,this.text="Error al cambiar el estado:"+o,this.color="error",this.initialize()}finally{Swal.close()}}}},X={key:1,class:"grey--text caption"},Y={class:"d-flex flex-column justify-center gap-5"},Z={class:"d-flex flex-wrap gap-2"},x=u("span",{class:"d-none d-sm-block"},"Subir foto",-1),_=u("span",{class:"d-none d-sm-block"},"Restablecer",-1),ee=u("p",{class:"text-body-1 mb-0"}," Formatos permitidos: JPG, GIF o PNG. Tamaño máximo 800KB ",-1),ae=u("span",null,"Seleccione un tenant primero",-1),te={key:1},se={class:"d-flex flex-wrap gap-1 align-center",style:{"min-width":"120px"}},le=["innerHTML"];function ie(e,a,o,p,k,i){const T=B("IconBtn");return r(),m(v,{title:"Administración de "+e.title},{default:l(()=>[s(w,{class:"d-flex px-2"},{default:l(()=>[s(S,{headers:i.showHeaders,items:i.filteredDesserts,search:e.search,class:"text-no-wrap striped-table"},{top:l(()=>[s(v,{flat:"",color:"white"},{default:l(()=>[s(w,null,{default:l(()=>[s(C,null,{default:l(()=>[s(n,{sm:"4",class:"pl-0 pt-20 py-2"},{default:l(()=>[s(V,{modelValue:e.search,"onUpdate:modelValue":a[0]||(a[0]=t=>e.search=t),"append-icon":"ri-search-line",label:"Busqueda de "+e.title},null,8,["modelValue","label"])]),_:1}),s(n,{sm:"4",class:"pt-20 py-2"},{default:l(()=>[s(U,{modelValue:e.selectedHeaders,"onUpdate:modelValue":a[1]||(a[1]=t=>e.selectedHeaders=t),items:e.headers,label:"Columnas Visibles",multiple:"","return-object":""},{selection:l(({item:t,index:d})=>[d<2?(r(),m(y,{key:0},{default:l(()=>[u("span",null,g(t.title),1)]),_:2},1024)):b("",!0),d===2?(r(),$("span",X," (otras "+g(e.selectedHeaders.length-2)+"+) ",1)):b("",!0)]),_:1},8,["modelValue","items"])]),_:1}),s(n,{sm:"1",class:"pt-20 py-2"},{default:l(()=>[s(H,{modelValue:e.dialog,"onUpdate:modelValue":a[16]||(a[16]=t=>e.dialog=t),"max-width":"500px"},{activator:l(({props:t})=>[s(c,P(t,{color:e.$cv("principal"),size:"x-large",title:"Registrar "+e.title}),{default:l(()=>[s(h,{size:"large",icon:"ri-add-circle-line"})]),_:2},1040,["color","title"])]),default:l(()=>[s(v,null,{default:l(()=>[s(A,{color:e.$cv("principal")},{default:l(()=>[s(c,{icon:"ri-close-line",color:"white",onClick:a[2]||(a[2]=t=>e.dialog=!1)}),s(z,null,{default:l(()=>[f(g(i.formTitle),1)]),_:1}),s(R)]),_:1},8,["color"]),s(G,{ref:"form",modelValue:e.valid,"onUpdate:modelValue":a[15]||(a[15]=t=>e.valid=t)},{default:l(()=>[s(w,null,{default:l(()=>[s(O,{class:"py-0"},{default:l(()=>[s(C,{class:"py-0"},{default:l(()=>[s(n,{cols:"12"},{default:l(()=>[s(v,null,{default:l(()=>[s(w,{class:"d-flex"},{default:l(()=>[!e.imagePreview&&!e.editedItem.image?(r(),m(I,{key:0,rounded:"lg",size:"100",class:"me-6",image:e.avatar},null,8,["image"])):e.imagePreview?(r(),m(I,{key:1,rounded:"lg",size:"100",class:"me-6",image:e.imagePreview},null,8,["image"])):e.editedItem.image?(r(),m(I,{key:2,rounded:"lg",size:"100",class:"me-6",image:i.getImageUrl(e.editedItem.image)},null,8,["image"])):b("",!0),u("div",Y,[u("div",Z,[s(c,{color:"primary",onClick:a[3]||(a[3]=t=>e.$refs.fileInput.click())},{default:l(()=>[s(h,{icon:"ri-upload-cloud-line",class:"d-sm-none"}),x]),_:1}),u("input",{ref:"fileInput",type:"file",name:"image",accept:".jpeg,.png,.jpg,.gif",hidden:"",onChange:a[4]||(a[4]=(...t)=>i.handleFileUpload&&i.handleFileUpload(...t))},null,544),s(c,{color:"error",variant:"outlined",onClick:i.resetAvatar},{default:l(()=>[_,s(h,{icon:"ri-refresh-line",class:"d-sm-none"})]),_:1},8,["onClick"])]),ee])]),_:1}),s(M)]),_:1})]),_:1}),s(n,{cols:"12",sm:"12"},{default:l(()=>[s(C,{class:"py-0"},{default:l(()=>[s(n,{cols:"12",sm:"12"},{default:l(()=>[s(V,{modelValue:e.editedItem.name,"onUpdate:modelValue":a[5]||(a[5]=t=>e.editedItem.name=t),label:"Nombre",required:"",rules:[t=>!!t||"Nombre es requerido"]},null,8,["modelValue","rules"])]),_:1}),s(n,{cols:"12",sm:"12"},{default:l(()=>[s(V,{modelValue:e.editedItem.email,"onUpdate:modelValue":a[6]||(a[6]=t=>e.editedItem.email=t),label:"Email",required:"",rules:e.emailRules},null,8,["modelValue","rules"])]),_:1}),s(n,{cols:"12",sm:"12"},{default:l(()=>[s(U,{modelValue:e.editedItem.tenant_id,"onUpdate:modelValue":a[7]||(a[7]=t=>e.editedItem.tenant_id=t),items:e.tenants,"item-title":"name","item-value":"id",label:"Tenant",required:"",rules:[t=>!!t||"Tenant es requerido"]},null,8,["modelValue","items","rules"])]),_:1}),s(n,{cols:"12"},{default:l(()=>[s(U,{modelValue:e.editedItem.roles,"onUpdate:modelValue":a[8]||(a[8]=t=>e.editedItem.roles=t),items:e.roles,"item-title":"name","item-value":"id",label:"Rol",disabled:!e.editedItem.tenant_id,loading:e.rolesLoading,clearable:"",rules:[t=>!!t||"Rol es requerido"]},N({_:2},[e.editedItem.tenant_id?void 0:{name:"prepend-inner",fn:l(()=>[s(J,{location:"bottom"},{activator:l(({props:t})=>[s(h,P(t,{icon:"ri-information-line"}),null,16)]),default:l(()=>[ae]),_:1})]),key:"0"}]),1032,["modelValue","items","disabled","loading","rules"])]),_:1}),s(n,{cols:"12",sm:"12"},{default:l(()=>[e.editedIndex===-1?(r(),m(V,{key:0,modelValue:e.editedItem.password,"onUpdate:modelValue":a[9]||(a[9]=t=>e.editedItem.password=t),label:"Contraseña",type:e.showPassword?"text":"password","append-icon":e.showPassword?"ri-eye-line":"ri-eye-off-line","onClick:append":a[10]||(a[10]=t=>e.showPassword=!e.showPassword),rules:e.passwordRules},null,8,["modelValue","type","append-icon","rules"])):(r(),m(V,{key:1,modelValue:e.editedItem.password,"onUpdate:modelValue":a[11]||(a[11]=t=>e.editedItem.password=t),label:"Nueva Contraseña (dejar en blanco para no cambiar)",type:e.showPassword?"text":"password","append-icon":e.showPassword?"ri-eye-line":"ri-eye-off-line","onClick:append":a[12]||(a[12]=t=>e.showPassword=!e.showPassword)},null,8,["modelValue","type","append-icon"]))]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})]),_:1}),s(L,null,{default:l(()=>[s(R),s(c,{variant:"outlined",color:"primary",onClick:a[13]||(a[13]=t=>e.dialog=!1)},{default:l(()=>[f("Cancelar")]),_:1}),s(c,{class:"bg-primary",color:"white",onClick:a[14]||(a[14]=t=>e.$saveUser())},{default:l(()=>[f("Guardar")]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1})]),_:1},8,["modelValue"])]),_:1})]),_:1})]),_:1})]),_:1})]),"item.active":l(({item:t})=>[s(y,{color:e.$resolveStatusVariant(t.active).color,density:"comfortable"},{default:l(()=>[f(g(e.$resolveStatusVariant(t.active).text),1)]),_:2},1032,["color"])]),"item.image":l(({item:t})=>[t.image?(r(),m(I,{key:0,image:i.getImageUrl(t.image),"max-height":"50","max-width":"50",contain:""},null,8,["image"])):(r(),$("span",te))]),"item.tenant.name":l(({item:t})=>[t.tenant?(r(),m(y,{key:0,class:"ma-1",color:i.getTenantColor(t)},{default:l(()=>[f(g(t.tenant.name),1)]),_:2},1032,["color"])):b("",!0)]),"item.roles":l(({item:t})=>[(r(!0),$(D,null,q(t.roles,d=>(r(),m(y,{key:d.id,class:"ma-1",color:i.getRandomColor(t)},{default:l(()=>[f(g(d.name),1)]),_:2},1032,["color"]))),128))]),"item.actions":l(({item:t})=>[u("div",se,[s(T,{size:"small",class:"my-1",title:"Editar",onClick:d=>i.editItem(t)},{default:l(()=>[s(h,{icon:"ri-pencil-line"})]),_:2},1032,["onClick"]),s(K,{modelValue:t.active,"onUpdate:modelValue":d=>t.active=d,"true-value":1,"false-value":0,color:"primary","hide-details":"",title:"Activar o Inactivar",onClick:d=>i.toggleActive(t)},null,8,["modelValue","onUpdate:modelValue","onClick"]),s(T,{size:"small",title:"Eliminar",class:"my-1",onClick:d=>e.$deleteItem(t.id,t.name)},{default:l(()=>[s(h,{icon:"ri-delete-bin-line"})]),_:2},1032,["onClick"])])]),_:1},8,["headers","items","search"]),s(j,{modelValue:e.snackbar,"onUpdate:modelValue":a[18]||(a[18]=t=>e.snackbar=t),bottom:!0,color:e.color,timeout:e.timeout},{action:l(({attrs:t})=>[s(c,P({dark:"",text:""},t,{onClick:a[17]||(a[17]=d=>e.snackbar=!1)}),{default:l(()=>[f("Cerrar")]),_:2},1040)]),default:l(()=>[u("div",{innerHTML:e.text},null,8,le)]),_:1},8,["modelValue","color","timeout"])]),_:1})]),_:1},8,["title"])}const Le=F(Q,[["render",ie]]);export{Le as default};
